<div class="agenda-container">
  <!-- Header de la agenda -->
  <mat-card class="agenda-header">
    <mat-card-header>
      <mat-card-title>
        Agenda {{ getMonthName() }} {{ anio }}
      </mat-card-title>
      <mat-card-subtitle>
        Instalaci√≥n ID: {{ instalacionId }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="exportAgenda()">
        <mat-icon>file_download</mat-icon>
        Exportar
      </button>
      <button mat-raised-button color="accent" (click)="closeAgenda()" 
              [disabled]="agenda?.estado === 'CERRADA'">
        <mat-icon>lock</mat-icon>
        Cerrar Mes
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Secci√≥n para agregar trabajadores -->
  <mat-card class="trabajador-selector" *ngIf="trabajadoresEnCalendario.length === 0">
    <mat-card-content>
      <div class="empty-calendar-message">
        <mat-icon>person_add</mat-icon>
        <p>No hay trabajadores en el calendario. Selecciona trabajadores desde la columna "Trabajador" para comenzar.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando trabajadores disponibles...</p>
  </div>

  <!-- Versi√≥n Desktop: Tabla Horizontal -->
  <div *ngIf="!isLoading && agenda && !isVerticalView" class="agenda-table-container desktop-view">
    <table mat-table [dataSource]="agenda.trabajadores" class="agenda-table">
      
      <!-- Columna de trabajador -->
      <ng-container matColumnDef="trabajador">
        <th mat-header-cell *matHeaderCellDef class="trabajador-header">
          <div class="header-content">
            <span>Trabajador</span>
            <mat-form-field appearance="outline" class="trabajador-select-header">
              <mat-label>Agregar trabajador</mat-label>
              <mat-select [(value)]="trabajadorSeleccionadoDropdown" 
                          placeholder="Seleccionar..."
                          (selectionChange)="onTrabajadorSeleccionado($event.value)">
                <mat-option *ngFor="let trabajador of trabajadoresDisponiblesParaAgregar" 
                            [value]="trabajador">
                  {{ trabajador.nombreCompleto }} - {{ trabajador.perfilPrimario.nombre }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </th>
        <td mat-cell *matCellDef="let trabajador" class="trabajador-cell">
          <div class="trabajador-info">
            <strong>{{ trabajador.nombreCompleto }}</strong>
            <button mat-icon-button 
                    class="quitar-trabajador-btn"
                    (click)="quitarTrabajadorDelCalendario(trabajador)"
                    matTooltip="Quitar del calendario"
                    color="warn">
              <mat-icon>remove_circle_outline</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Columnas de d√≠as -->
      <ng-container *ngFor="let day of daysInMonth; let dayIndex = index" 
                    [matColumnDef]="'day-' + day">
        <th mat-header-cell *matHeaderCellDef class="day-header" 
            [class.feriado]="isFeriado(dayIndex)"
            [title]="getFeriadoInfo(dayIndex)">
          {{ day }}
          <span *ngIf="isFeriado(dayIndex)" class="feriado-indicator">üéâ</span>
        </th>
        <td mat-cell *matCellDef="let trabajador; let rowIndex = index" 
            class="turno-cell-container"
            matTooltip="Clic para men√∫ contextual"
            matTooltipPosition="above"
            (click)="onCellSingleClick(trabajador, dayIndex, $event)"
            (dblclick)="onCellDoubleClick(trabajador, dayIndex)">
          <div [class]="getTurnoCssClass(agenda!.turnos[rowIndex][dayIndex])"
               [title]="getTurnoDisplayText(agenda!.turnos[rowIndex][dayIndex])">
            <span class="turno-icon">{{ getTurnoIcon(agenda!.turnos[rowIndex][dayIndex]) }}</span>
            <span class="turno-text">{{ getTurnoDisplayText(agenda!.turnos[rowIndex][dayIndex]) }}</span>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

  <!-- Versi√≥n Mobile: Vista Vertical con Paginaci√≥n por Semanas -->
  <div *ngIf="!isLoading && agenda && isVerticalView" class="agenda-vertical-container mobile-view">
    
    <!-- Selector de trabajador para m√≥vil -->
    <mat-card class="trabajador-selector-mobile">
      <mat-card-content>
        <mat-form-field appearance="outline" class="trabajador-select-mobile">
          <mat-label>Agregar trabajador al calendario</mat-label>
          <mat-select [(value)]="trabajadorSeleccionadoDropdown" 
                      placeholder="Seleccionar trabajador..."
                      (selectionChange)="onTrabajadorSeleccionado($event.value)">
            <mat-option *ngFor="let trabajador of trabajadoresDisponiblesParaAgregar" 
                        [value]="trabajador">
              {{ trabajador.nombreCompleto }} - {{ trabajador.perfilPrimario.nombre }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <div class="trabajadores-count" *ngIf="trabajadoresEnCalendario.length > 0">
          <small>{{ trabajadoresEnCalendario.length }} trabajador(es) en calendario</small>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Navegaci√≥n de semanas -->
    <mat-card class="semana-navigation">
      <mat-card-content>
        <div class="nav-controls">
          <button mat-icon-button 
                  (click)="cambiarSemana('anterior')" 
                  [disabled]="semanaActual === 1"
                  matTooltip="Semana anterior">
            <mat-icon>chevron_left</mat-icon>
          </button>
          
          <div class="semana-info">
            <h3>Semana {{ semanaActual }} de {{ totalSemanas }}</h3>
            <p>{{ getMonthName() }} {{ anio }}</p>
          </div>
          
          <button mat-icon-button 
                  (click)="cambiarSemana('siguiente')" 
                  [disabled]="semanaActual === totalSemanas"
                  matTooltip="Semana siguiente">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
        
        <!-- Indicadores de semana -->
        <div class="semana-indicators">
          <button *ngFor="let semana of semanasDelMes; let i = index"
                  mat-mini-fab
                  [color]="semanaActual === semana.numero ? 'primary' : ''"
                  (click)="irASemana(semana.numero)"
                  [matTooltip]="'Ir a semana ' + semana.numero">
            {{ semana.numero }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Lista de trabajadores con turnos de la semana -->
    <div class="trabajadores-list">
      <mat-card *ngFor="let trabajador of trabajadoresEnCalendario; let trabajadorIndex = index" 
                class="trabajador-card">
        <mat-card-header>
          <mat-card-title>
            <div class="trabajador-header-mobile">
              <span>{{ trabajador.nombreCompleto }}</span>
              <button mat-icon-button 
                      class="quitar-trabajador-btn-mobile"
                      (click)="quitarTrabajadorDelCalendario(trabajador)"
                      matTooltip="Quitar del calendario"
                      color="warn">
                <mat-icon>remove_circle_outline</mat-icon>
              </button>
            </div>
          </mat-card-title>
          <mat-card-subtitle>{{ trabajador.perfilPrimario.nombre }}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="dias-semana">
            <div *ngFor="let fecha of fechasDeLaSemanaActual; let diaIndex = index" 
                 class="dia-item">
              <div class="dia-header">
                <span class="dia-nombre">{{ getNombreDiaSemana(fecha) }}</span>
                <span class="dia-numero">{{ fecha.getDate() }}</span>
                <span *ngIf="isFeriado(fecha.getDate() - 1)" class="feriado-indicator">üéâ</span>
              </div>
              
              <div class="turno-container"
                   (click)="onCellSingleClick(trabajador, fecha.getDate() - 1, $event)"
                   (dblclick)="onCellDoubleClick(trabajador, fecha.getDate() - 1)">
                <div [class]="getTurnoCssClass(agenda!.turnos[trabajadorIndex][fecha.getDate() - 1]) + ' turno-mobile'"
                     [title]="getTurnoDisplayText(agenda!.turnos[trabajadorIndex][fecha.getDate() - 1])">
                  <span class="turno-icon">{{ getTurnoIcon(agenda!.turnos[trabajadorIndex][fecha.getDate() - 1]) }}</span>
                  <span class="turno-text">{{ getTurnoDisplayText(agenda!.turnos[trabajadorIndex][fecha.getDate() - 1]) }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Leyenda -->
  <mat-card class="agenda-legend" *ngIf="!isLoading && agenda">
    <mat-card-header>
      <mat-card-title>Leyenda</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="legend-items">
        <div class="legend-item">
          <span class="turno-cell turno-normal turno-diurno">‚òÄÔ∏è TD</span>
          <span>Turno Diurno</span>
        </div>
        <div class="legend-item">
          <span class="turno-cell turno-normal turno-nocturno">üåô TN</span>
          <span>Turno Nocturno</span>
        </div>
        <div class="legend-item">
          <span class="turno-cell turno-normal turno-personalizado">‚è∞ TP</span>
          <span>Turno Personalizado</span>
        </div>
        <div class="legend-item">
          <span class="turno-cell turno-multiple">üîÑ TD+TN</span>
          <span>Turnos M√∫ltiples</span>
        </div>
        <div class="legend-item">
          <span class="turno-cell turno-conflict">‚ö†Ô∏è</span>
          <span>Conflicto</span>
        </div>
        <div class="legend-item">
          <span class="feriado-indicator">üéâ</span>
          <span>Feriado</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Resumen estad√≠sticas -->
  <mat-card class="agenda-stats" *ngIf="!isLoading && agenda">
    <mat-card-header>
      <mat-card-title>Resumen del Mes</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item">
          <strong>{{ agenda.trabajadores.length }}</strong>
          <span>Trabajadores</span>
        </div>
        <div class="stat-item">
          <strong>{{ agenda.feriados.length }}</strong>
          <span>Feriados</span>
        </div>
        <div class="stat-item">
          <strong>{{ agenda.estado }}</strong>
          <span>Estado</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Mensaje si no hay datos -->
  <mat-card *ngIf="!isLoading && !agenda" class="no-data">
    <mat-card-content>
      <mat-icon>calendar_today</mat-icon>
      <h3>No hay agenda disponible</h3>
      <p>No se encontr√≥ agenda para el per√≠odo seleccionado.</p>
    </mat-card-content>
  </mat-card>
</div>

<!-- Men√∫ Contextual -->
<div *ngIf="mostrarMenuContextual" class="menu-contextual-overlay" 
     [style.left.px]="posicionMenu.x" 
     [style.top.px]="posicionMenu.y">
  
  <!-- Backdrop para cerrar el men√∫ -->
  <div class="menu-backdrop" (click)="cerrarMenuContextual()"></div>
  
  <!-- Contenido del men√∫ -->
  <div class="menu-content">
    <button mat-menu-item (click)="asignarTurnoRapido('DIURNO')">
      <mat-icon>wb_sunny</mat-icon>
      <span>Diurno</span>
    </button>
    
    <button mat-menu-item (click)="asignarTurnoRapido('NOCTURNO')">
      <mat-icon>nightlight_round</mat-icon>
      <span>Nocturno</span>
    </button>
    
    <mat-divider></mat-divider>
    
    <button mat-menu-item (click)="asignarTurnoDoble()" 
            *ngIf="!tieneTurnoDoble()">
      <mat-icon>sync</mat-icon>
      <span>Turno Doble (Noche + D√≠a)</span>
    </button>
    
    <button mat-menu-item (click)="asignarTurnoDoble()" 
            *ngIf="tieneTurnoDoble()">
      <mat-icon>sync_disabled</mat-icon>
      <span>Quitar Turno Doble</span>
    </button>
    
    <mat-divider></mat-divider>
    
    <button mat-menu-item (click)="abrirModalParaEditar()">
      <mat-icon>edit</mat-icon>
      <span>Edici√≥n Avanzada</span>
    </button>
    
    <button mat-menu-item (click)="eliminarTodosTurnos()" 
            *ngIf="tieneTurnos()">
      <mat-icon>clear</mat-icon>
      <span>Limpiar D√≠a</span>
    </button>
  </div>
</div>
